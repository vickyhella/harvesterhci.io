<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.17">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-56382716-11","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="alternate" type="application/rss+xml" href="/kb/rss.xml" title="The open source hyperconverged infrastructure (HCI) solution for a cloud native world RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/kb/atom.xml" title="The open source hyperconverged infrastructure (HCI) solution for a cloud native world Atom Feed"><title data-rh="true">3 posts tagged with &quot;longhorn&quot; | The open source hyperconverged infrastructure (HCI) solution for a cloud native world</title><meta data-rh="true" property="og:title" content="3 posts tagged with &quot;longhorn&quot; | The open source hyperconverged infrastructure (HCI) solution for a cloud native world"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://harvesterhci.io/kb/tags/longhorn"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="blog_tags_posts"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_tags_posts"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://harvesterhci.io/kb/tags/longhorn"><link data-rh="true" rel="alternate" href="https://harvesterhci.io/kb/tags/longhorn" hreflang="en"><link data-rh="true" rel="alternate" href="https://harvesterhci.io/kb/tags/longhorn" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.98d31bb7.css">
<link rel="preload" href="/assets/js/runtime~main.2ad8bfda.js" as="script">
<link rel="preload" href="/assets/js/main.0bb3d69e.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo_horizontal.svg" alt="Harvester Logo" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/logo_horizontal.svg" alt="Harvester Logo" class="themedImage_W2Cr themedImage--dark_oUvU"></div></a></div><div class="navbar__items navbar__items--right"><a href="https://docs.harvesterhci.io/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar__docs"><span>Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://www.suse.com/c/?s=harvester" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar__blog"><span>Blog<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a aria-current="page" class="navbar__item navbar__link navbar__kb navbar__link--active" href="/kb">Knowledge Base</a><a href="https://github.com/harvester/harvester" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar__github btn btn-secondary icon-github"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-tags-post-list-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_a9qW thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_uKok margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Kvuv"><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kb/configure_priority_class_longhorn">Configure PriorityClass on Longhorn System Components</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kb/package_your_own_toolbox_image">Package your own Toolbox Image</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kb/scan-and-repair-vm-root-filesystem">Scan and Repair Root Filesystem of VirtualMachine</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kb/evicting-replicas-from-a-disk-the-cli-way">Evicting Replicas From a Disk (the CLI way)</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kb/nic-naming-scheme">NIC Naming Scheme</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><header class="margin-bottom--xl"><h1>3 posts tagged with &quot;longhorn&quot;</h1><a href="/kb/tags">View All Tags</a></header><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/kb/configure_priority_class_longhorn">Configure PriorityClass on Longhorn System Components</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2023-07-25T00:00:00.000Z" itemprop="datePublished">July 25, 2023</time> · <!-- -->7 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/bk201" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/bk201.png" alt="Kiefer Chang"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/bk201" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Kiefer Chang</span></a></div><small class="avatar__subtitle" itemprop="description">Engineer Manager</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p><strong>Harvester v1.2.0</strong>  introduces a new enhancement where Longhorn system-managed components in newly-deployed clusters are automatically assigned a <code>system-cluster-critical</code> priority class by default. However, when upgrading your Harvester clusters from previous versions, you may notice that Longhorn system-managed components do not have any priority class set.</p><p>This behavior is intentional and aimed at supporting zero-downtime upgrades. Longhorn does not allow changing the <code>priority-class</code> setting when attached volumes exist. For more details, please refer to <a href="https://longhorn.io/docs/1.4.3/advanced-resources/deploy/priority-class/#setting-priority-class-during-longhorn-installation" target="_blank" rel="noopener noreferrer">Setting Priority Class During Longhorn Installation</a>).</p><p>This article explains how to manually configure priority classes for Longhorn system-managed components after upgrading your Harvester cluster, ensuring that your Longhorn components have the appropriate priority class assigned and maintaining the stability and performance of your system.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="stop-all-virtual-machines">Stop all virtual machines<a class="hash-link" href="#stop-all-virtual-machines" title="Direct link to heading">​</a></h2><p>Stop all virtual machines (VMs) to detach all volumes. Please back up any work before doing this.</p><ol><li><p><a href="https://docs.harvesterhci.io/v1.1/troubleshooting/os#how-to-log-into-a-harvester-node" target="_blank" rel="noopener noreferrer">Login to a Harvester controller node and become root</a>.</p></li><li><p>Get all running VMs and write down their namespaces and names:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get vmi -A</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Alternatively, you can get this information by backing up the Virtual Machine Instance (VMI) manifests with the following command:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get vmi -A -o json </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> vmi-backup.json</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li><li><p>Shut down all VMs. Log in to all running VMs and shut them down gracefully (recommended). Or use the following command to send shutdown signals to all VMs:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get vmi -A -o json </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> jq -r </span><span class="token string" style="color:#e3116c">&#x27;.items[] | [.metadata.name, .metadata.namespace] | @tsv&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token assign-left variable environment constant" style="color:#36acaa">IFS</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">$&#x27;</span><span class="token string entity" style="color:#36acaa">\t</span><span class="token string" style="color:#e3116c">&#x27;</span><span class="token plain"> </span><span class="token builtin class-name">read</span><span class="token plain"> -r name namespace</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> -z </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$name</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token builtin class-name">break</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">fi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Stop </span><span class="token string variable" style="color:#36acaa">${namespace}</span><span class="token string" style="color:#e3116c">/</span><span class="token string variable" style="color:#36acaa">${name}</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      virtctl stop </span><span class="token variable" style="color:#36acaa">$name</span><span class="token plain"> -n </span><span class="token variable" style="color:#36acaa">$namespace</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">done</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>  You can also stop all VMs from the Harvester UI:</p><ol><li>Go to the <strong>Virtual Machines</strong> page.</li><li>For each VM, select <strong>⋮</strong> &gt; <strong>Stop</strong>.</li></ol></div></div></li><li><p>Ensure there are no running VMs:</p><p>Run the command:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get vmi -A</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>The above command must return:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">No resources found</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li></ol><h2 class="anchor anchorWithStickyNavbar_mojV" id="scale-down-monitoring-pods">Scale down monitoring pods<a class="hash-link" href="#scale-down-monitoring-pods" title="Direct link to heading">​</a></h2><ol><li><p>Scale down the Prometheus deployment. Run the following command and wait for all Prometheus pods to terminate:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl patch -n cattle-monitoring-system prometheus/rancher-monitoring-prometheus --patch </span><span class="token string" style="color:#e3116c">&#x27;{&quot;spec&quot;: {&quot;replicas&quot;: 0}}&#x27;</span><span class="token plain"> --type merge </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">sleep</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kubectl rollout status --watch</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true -n cattle-monitoring-system statefulset/prometheus-rancher-monitoring-prometheus</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>A sample output looks like this:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">prometheus.monitoring.coreos.com/rancher-monitoring-prometheus patched</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">statefulset rolling update complete 0 pods at revision prometheus-rancher-monitoring-prometheus-cbf6bd5f7...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li><li><p>Scale down the AlertManager deployment. Run the following command and wait for all AlertManager pods to terminate:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl patch -n cattle-monitoring-system alertmanager/rancher-monitoring-alertmanager --patch </span><span class="token string" style="color:#e3116c">&#x27;{&quot;spec&quot;: {&quot;replicas&quot;: 0}}&#x27;</span><span class="token plain"> --type merge </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">sleep</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kubectl rollout status --watch</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true -n cattle-monitoring-system statefulset/alertmanager-rancher-monitoring-alertmanager</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>A sample output looks like this:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">alertmanager.monitoring.coreos.com/rancher-monitoring-alertmanager patched</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">statefulset rolling update complete 0 pods at revision alertmanager-rancher-monitoring-alertmanager-c8c459dff...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li><li><p>Scale down the Grafana deployment. Run the following command and wait for all Grafana pods to terminate:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl scale --replicas</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> deployment/rancher-monitoring-grafana -n cattle-monitoring-system </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">sleep</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kubectl rollout status --watch</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true -n cattle-monitoring-system deployment/rancher-monitoring-grafana</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>A sample output looks like this:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">deployment.apps/rancher-monitoring-grafana scaled</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment &quot;rancher-monitoring-grafana&quot; successfully rolled out</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li></ol><h2 class="anchor anchorWithStickyNavbar_mojV" id="scale-down-vm-import-controller-pods">Scale down vm-import-controller pods<a class="hash-link" href="#scale-down-vm-import-controller-pods" title="Direct link to heading">​</a></h2><ol><li><p>Check if the <a href="https://docs.harvesterhci.io/v1.1/advanced/vmimport" target="_blank" rel="noopener noreferrer"><code>vm-import-controller</code></a> addon is enabled and configured with a persistent volume with the following command:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get pvc -n harvester-system harvester-vm-import-controller</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>If the above command returns an output like this, you must scale down the <code>vm-import-controller</code> pod. Otherwise, you can skip the following step.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">NAME                             STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS         AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">harvester-vm-import-controller   Bound    pvc-eb23e838-4c64-4650-bd8f-ba7075ab0559   200Gi      RWO            harvester-longhorn   2m53s</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li><li><p>Scale down the <code>vm-import-controller</code> pods with the following command:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl scale --replicas</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> deployment/harvester-vm-import-controller -n harvester-system </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">sleep</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kubectl rollout status --watch</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true -n harvester-system deployment/harvester-vm-import-controller</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>A sample output looks like this:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">deployment.apps/harvester-vm-import-controller scaled</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment &quot;harvester-vm-import-controller&quot; successfully rolled out</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li></ol><h2 class="anchor anchorWithStickyNavbar_mojV" id="set-the-priority-class-setting">Set the <code>priority-class</code> setting<a class="hash-link" href="#set-the-priority-class-setting" title="Direct link to heading">​</a></h2><ol><li><p>Before applying the <code>priority-class</code> setting, you need to verify all volumes are detached. Run the following command to verify the <code>STATE</code> of each volume is <code>detached</code>:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get volumes.longhorn.io -A</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Verify the output looks like this:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">NAMESPACE         NAME                                       STATE      ROBUSTNESS   SCHEDULED   SIZE           NODE   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">longhorn-system   pvc-5743fd02-17a3-4403-b0d3-0e9b401cceed   detached   unknown                  5368709120            15d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">longhorn-system   pvc-7e389fe8-984c-4049-9ba8-5b797cb17278   detached   unknown                  53687091200           15d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">longhorn-system   pvc-8df64e54-ecdb-4d4e-8bab-28d81e316b8b   detached   unknown                  2147483648            15d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">longhorn-system   pvc-eb23e838-4c64-4650-bd8f-ba7075ab0559   detached   unknown                  214748364800          11m</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li><li><p>Set the <code>priority-class</code> setting with the following command:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl patch -n longhorn-system settings.longhorn.io priority-class --patch </span><span class="token string" style="color:#e3116c">&#x27;{&quot;value&quot;: &quot;system-cluster-critical&quot;}&#x27;</span><span class="token plain"> --type merge</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Longhorn system-managed pods will restart and then you need to check if all the system-managed components have a priority class set:</p><p>Get the value of the priority class <code>system-cluster-critical</code>:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get priorityclass system-cluster-critical</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Verify the output looks like this:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">NAME                      VALUE        GLOBAL-DEFAULT   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">system-cluster-critical   2000000000   false            15d</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li><li><p>Use the following command to get pods&#x27; priority in the <code>longhorn-system</code> namespace:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get pods -n longhorn-system -o custom-columns</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;Name&quot;</span><span class="token plain">:metadata.name,</span><span class="token string" style="color:#e3116c">&quot;Priority&quot;</span><span class="token plain">:.spec.priority</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li><li><p>Verify all system-managed components&#x27; pods have the correct priority. System-managed components include:</p><ul><li><code>csi-attacher</code></li><li><code>csi-provisioner</code></li><li><code>csi-resizer</code></li><li><code>csi-snapshotter</code></li><li><code>engine-image-ei</code></li><li><code>instance-manager-e</code></li><li><code>instance-manager-r</code></li><li><code>longhorn-csi-plugin</code></li></ul></li></ol><h2 class="anchor anchorWithStickyNavbar_mojV" id="scale-up-vm-import-controller-pods">Scale up vm-import-controller pods<a class="hash-link" href="#scale-up-vm-import-controller-pods" title="Direct link to heading">​</a></h2><p>If you scale down the <code>vm-import-controller</code> pods, you must scale it up again. </p><ol><li><p>Scale up the <code>vm-import-controller</code> pod. Run the command: </p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl scale --replicas</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> deployment/harvester-vm-import-controller -n harvester-system </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">sleep</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kubectl rollout status --watch</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true -n harvester-system deployment/harvester-vm-import-controller</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>A sample output looks like this:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">deployment.apps/harvester-vm-import-controller scaled</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Waiting for deployment &quot;harvester-vm-import-controller&quot; rollout to finish: 0 of 1 updated replicas are available...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment &quot;harvester-vm-import-controller&quot; successfully rolled out</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li><li><p>Verify <code>vm-import-controller</code> is running using the following command:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get pods --selector app.kubernetes.io/instance</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">vm-import-controller -A</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>A sample output looks like this, the pod&#x27;s <code>STATUS</code> must be <code>Running</code>:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">NAMESPACE          NAME                                              READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">harvester-system   harvester-vm-import-controller-6bd8f44f55-m9k86   1/1     Running   0          4m53s</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li></ol><h2 class="anchor anchorWithStickyNavbar_mojV" id="scale-up-monitoring-pods">Scale up monitoring pods<a class="hash-link" href="#scale-up-monitoring-pods" title="Direct link to heading">​</a></h2><ol><li><p>Scale up the Prometheus deployment. Run the following command and wait for all Prometheus pods to roll out:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl patch -n cattle-monitoring-system prometheus/rancher-monitoring-prometheus --patch </span><span class="token string" style="color:#e3116c">&#x27;{&quot;spec&quot;: {&quot;replicas&quot;: 1}}&#x27;</span><span class="token plain"> --type merge </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">sleep</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kubectl rollout status --watch</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true -n cattle-monitoring-system statefulset/prometheus-rancher-monitoring-prometheus</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>A sample output looks like:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">prometheus.monitoring.coreos.com/rancher-monitoring-prometheus patched</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Waiting for 1 pods to be ready...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">statefulset rolling update complete 1 pods at revision prometheus-rancher-monitoring-prometheus-cbf6bd5f7...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li><li><p>Scale down the AlertManager deployment. Run the following command and wait for all AlertManager pods to roll out:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl patch -n cattle-monitoring-system alertmanager/rancher-monitoring-alertmanager --patch </span><span class="token string" style="color:#e3116c">&#x27;{&quot;spec&quot;: {&quot;replicas&quot;: 1}}&#x27;</span><span class="token plain"> --type merge </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">sleep</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kubectl rollout status --watch</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true -n cattle-monitoring-system statefulset/alertmanager-rancher-monitoring-alertmanager</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>A sample output looks like this:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">alertmanager.monitoring.coreos.com/rancher-monitoring-alertmanager patched</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Waiting for 1 pods to be ready...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">statefulset rolling update complete 1 pods at revision alertmanager-rancher-monitoring-alertmanager-c8bd4466c...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li><li><p>Scale down the Grafana deployment. Run the following command and wait for all Grafana pods to roll out:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl scale --replicas</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> deployment/rancher-monitoring-grafana -n cattle-monitoring-system </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">sleep</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kubectl rollout status --watch</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true -n cattle-monitoring-system deployment/rancher-monitoring-grafana</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>A sample output looks like this:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">deployment.apps/rancher-monitoring-grafana scaled</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Waiting for deployment &quot;rancher-monitoring-grafana&quot; rollout to finish: 0 of 1 updated replicas are available...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment &quot;rancher-monitoring-grafana&quot; successfully rolled out</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li></ol><h2 class="anchor anchorWithStickyNavbar_mojV" id="start-virtual-machines">Start virtual machines<a class="hash-link" href="#start-virtual-machines" title="Direct link to heading">​</a></h2><ol><li><p>Start a VM with the command:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">virtctl start </span><span class="token variable" style="color:#36acaa">$name</span><span class="token plain"> -n </span><span class="token variable" style="color:#36acaa">$namespace</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Replace <code>$name</code> with the VM&#x27;s name and <code>$namespace</code> with the VM&#x27;s namespace. You can list all virtual machines with the command:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get vms -A</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p> You can also stop all VMs from the Harvester UI:</p><ol><li>Go to the <strong>Virtual Machines</strong> page.</li><li>For each VM, select <strong>⋮</strong> &gt; <strong>Start</strong>.</li></ol></div></div><p>Alternatively, you can start all running VMs with the following command:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> vmi-backup.json </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> jq -r </span><span class="token string" style="color:#e3116c">&#x27;.items[] | [.metadata.name, .metadata.namespace] | @tsv&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token assign-left variable environment constant" style="color:#36acaa">IFS</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">$&#x27;</span><span class="token string entity" style="color:#36acaa">\t</span><span class="token string" style="color:#e3116c">&#x27;</span><span class="token plain"> </span><span class="token builtin class-name">read</span><span class="token plain"> -r name namespace</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> -z </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$name</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token builtin class-name">break</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">fi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Start </span><span class="token string variable" style="color:#36acaa">${namespace}</span><span class="token string" style="color:#e3116c">/</span><span class="token string variable" style="color:#36acaa">${name}</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      virtctl start </span><span class="token variable" style="color:#36acaa">$name</span><span class="token plain"> -n </span><span class="token variable" style="color:#36acaa">$namespace</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">done</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li></ol></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/harvester">harvester</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/longhorn">longhorn</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/priority-class">priority class</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Configure PriorityClass on Longhorn System Components" href="/kb/configure_priority_class_longhorn"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/kb/scan-and-repair-vm-root-filesystem">Scan and Repair Root Filesystem of VirtualMachine</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2023-02-01T00:00:00.000Z" itemprop="datePublished">February 1, 2023</time> · <!-- -->3 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/Vicente-Cheng" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/Vicente-Cheng.png" alt="Vicente Cheng"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/Vicente-Cheng" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Vicente Cheng</span></a></div><small class="avatar__subtitle" itemprop="description">Senior Software Engineer</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>In earlier versions of Harvester (v1.0.3 and prior), Longhorn volumes may get corrupted during the replica rebuilding process (reference: <a href="https://longhorn.io/kb/troubleshooting-volume-filesystem-corruption/#solution" target="_blank" rel="noopener noreferrer">Analysis: Potential Data/Filesystem Corruption</a>). In Harvester v1.1.0 and later versions, the Longhorn team has fixed this issue. This article covers manual steps you can take to scan the VM&#x27;s filesystem and repair it if needed.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="stop-the-vm-and-backup-volume">Stop The VM And Backup Volume<a class="hash-link" href="#stop-the-vm-and-backup-volume" title="Direct link to heading">​</a></h2><p>Before you scan the filesystem, it is recommend you back up the volume first. For an example, refer to the following steps to stop the VM and backup the volume.</p><ul><li>Find the target VM.</li></ul><p><img loading="lazy" alt="finding the target VM" src="/assets/images/finding_the_target_vm-c3f5c227fdeda94499a32e880a302e80.png" width="2560" height="880"></p><ul><li>Stop the target VM.</li></ul><p><img loading="lazy" alt="Stop the target VM" src="/assets/images/stop_the_target_vm-35b68914885fd42f4b7310aa849f944f.png" width="2546" height="856"></p><p>The target VM is stopped and the related volumes are detached. Now go to the Longhorn UI to backup this volume.</p><ul><li>Enable <code>Developer Tools &amp; Features</code> (Preferences -&gt; Enable Developer Tools &amp; Features).</li></ul><p><img loading="lazy" alt="Preferences then enable developer mode" src="/assets/images/preferences_enable_developer_mode-1379680f02f9980091177736ed7ce523.png" width="2570" height="1090">
<img loading="lazy" alt="Enable the developer mode" src="/assets/images/enable_the_developer_mode-8dffb1796b8e5da9863d6c69ad7f0209.png" width="2760" height="350"></p><ul><li>Click the <code>⋮</code> button and select <strong>Edit Config</strong> to edit the config page of the VM.</li></ul><p><img loading="lazy" alt="goto edit config page of VM" src="/assets/images/goto_vm_edit_config_page-52e958d3a5e04c912e77615d3ab05616.png" width="2526" height="964"></p><ul><li>Go to the <code>Volumes</code> tab and select <code>Check volume details.</code></li></ul><p><img loading="lazy" alt="link to longhorn volume page" src="/assets/images/link_to_longhorn_volume-ced67ce270fd55fa7ff5a73c651ae940.png" width="2522" height="1372"></p><ul><li>Click the dropdown menu on the right side and select &#x27;Attach&#x27; to attach the volume again. </li></ul><p><img loading="lazy" alt="attach this volume again" src="/assets/images/attach_this_volume_again-f008c1d56b9cdfa2b141e30093cc51fe.png" width="2972" height="1358"></p><ul><li>Select the attached node. </li></ul><p><img loading="lazy" alt="choose the attached node" src="/assets/images/choose_the_attached_node-cde38647a09abf50189b40f5a37da9cb.png" width="2964" height="1362"></p><ul><li>Check the volume attached under <code>Volume Details</code> and select <code>Take Snapshot</code> on this volume page.</li></ul><p><img loading="lazy" alt="take snapshot on volume page" src="/assets/images/take_snapshot_on_volume_page-fe966d238b47aea3360b6f5c55664846.png" width="2976" height="1358"></p><ul><li>Confirm that the snapshot is ready.</li></ul><p><img loading="lazy" alt="check the snapshot is ready" src="/assets/images/check_the_snapshot_is_ready-7f0716b1b699c668c11ad5b5b46596b0.png" width="2968" height="1356"></p><p>Now that you completed the volume backup, you need to scan and repair the root filesystem.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="scanning-the-root-filesystem-and-repairing">Scanning the root filesystem and repairing<a class="hash-link" href="#scanning-the-root-filesystem-and-repairing" title="Direct link to heading">​</a></h2><p>This section will introduce how to scan the filesystem (e.g., XFS, EXT4) using related tools.</p><p>Before scanning, you need to know the filesystem&#x27;s device/partition.</p><ul><li>Find the filesystem&#x27;s device by running the <code>dmesg</code> command. The most recent device should be what we wanted because we attach the latest.</li><li>You should now know the filesystem&#x27;s partition. In the example below, sdd3 is the filesystem&#x27;s partition.</li></ul><p><img loading="lazy" alt="finding the related device" src="/assets/images/finding_related_device-65244c8157777d7503b6262c4522c202.png" width="3010" height="550"></p><ul><li>Use the Filesystem toolbox image to scan and repair.</li></ul><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># docker run -it --rm --privileged registry.opensuse.org/isv/rancher/harvester/toolbox/main/fs-toolbox:latest -- bash</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Then we try to scan with this target device.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="xfs">XFS<a class="hash-link" href="#xfs" title="Direct link to heading">​</a></h3><p>When scanning a XFS filesystem, use the <code>xfs_repair</code> command as follows, where <code>/dev/sdd3</code> is the problematic partition of the device.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># xfs_repair -n /dev/sdd3</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>To repair the corrupted partition, run the following command.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># xfs_repair /dev/sdd3</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="ext4">EXT4<a class="hash-link" href="#ext4" title="Direct link to heading">​</a></h3><p>When scanning a EXT4 filesystem, use the <code>e2fsck</code> command as follows, where the <code>/dev/sde1</code> is the problematic partition of the device.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># e2fsck -f /dev/sde1</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>To repair the corrupted partition, run the following command.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># e2fsck -fp /dev/sde1</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>After using the &#x27;e2fsck&#x27; command, you should also see logs related to scanning and repairing the partition. Scanning and repairing the corrupted partition is successful if there are no errors in these logs. </p><h2 class="anchor anchorWithStickyNavbar_mojV" id="detach-and-start-vm-again">Detach and Start VM again.<a class="hash-link" href="#detach-and-start-vm-again" title="Direct link to heading">​</a></h2><p>After the corrupted partition is scanned and repaired, detach the volume and try to start the related VM again.</p><ul><li>Detach the volume from the Longhorn UI.</li></ul><p><img loading="lazy" alt="detach volume on longhorn UI" src="/assets/images/detach_volume-a71a0c79f0a6052fd5ecb562bf532b71.png" width="2964" height="1364"></p><ul><li>Start the related VM again from the Longhorn UI.</li></ul><p><img loading="lazy" alt="Start VM again" src="/assets/images/start_vm_again-6ce38c23de061f1587da9e4f8698b7e8.png" width="2540" height="854"></p><p>Your VM should now work normally.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/storage">storage</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/longhorn">longhorn</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/root">root</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/filesystem">filesystem</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Scan and Repair Root Filesystem of VirtualMachine" href="/kb/scan-and-repair-vm-root-filesystem"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/kb/evicting-replicas-from-a-disk-the-cli-way">Evicting Replicas From a Disk (the CLI way)</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2023-01-12T00:00:00.000Z" itemprop="datePublished">January 12, 2023</time> · <!-- -->2 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/bk201" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/bk201.png" alt="Kiefer Chang"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/bk201" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Kiefer Chang</span></a></div><small class="avatar__subtitle" itemprop="description">Engineer Manager</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Harvester replicates volumes data across disks in a cluster. Before removing a disk, the user needs to evict replicas on the disk to other disks to preserve the volumes&#x27; configured availability. For more information about eviction in Longhorn, please check <a href="https://longhorn.io/docs/1.3.2/volumes-and-nodes/disks-or-nodes-eviction/" target="_blank" rel="noopener noreferrer">Evicting Replicas on Disabled Disks or Nodes</a>.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="preparation">Preparation<a class="hash-link" href="#preparation" title="Direct link to heading">​</a></h2><p>This document describes how to evict Longhorn disks using the <code>kubectl</code> command. Before that, users must ensure the environment is set up correctly.
There are two recommended ways to do this:</p><ol><li>Log in to any management node and switch to root (<code>sudo -i</code>).</li><li>Download Kubeconfig file and use it locally<ul><li>Install <code>kubectl</code> and <code>yq</code> program manually.</li><li>Open Harvester GUI,  click <code>support</code> at the bottom left of the page and click <code>Download KubeConfig</code> to download the Kubeconfig file.</li><li>Set the Kubeconfig file&#x27;s path to <code>KUBECONFIG</code> environment variable. For example, <code>export KUBECONFIG=/path/to/kubeconfig</code>.</li></ul></li></ol><h2 class="anchor anchorWithStickyNavbar_mojV" id="evicting-replicas-from-a-disk">Evicting replicas from a disk<a class="hash-link" href="#evicting-replicas-from-a-disk" title="Direct link to heading">​</a></h2><ol><li><p>List Longhorn nodes (names are identical to Kubernetes nodes):</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get -n longhorn-system nodes.longhorn.io</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Sample output:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">NAME    READY   ALLOWSCHEDULING   SCHEDULABLE   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">node1   True    true              True          24d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">node2   True    true              True          24d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">node3   True    true              True          24d</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li><li><p>List disks on a node. Assume we want to evict replicas of a disk on <code>node1</code>:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get -n longhorn-system nodes.longhorn.io node1 -o yaml | yq e &#x27;.spec.disks&#x27;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Sample output:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">default-disk-ed7af10f5b8356be:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  allowScheduling: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  evictionRequested: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  path: /var/lib/harvester/defaultdisk</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  storageReserved: 36900254515</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tags: []</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li><li><p>Assume disk <code>default-disk-ed7af10f5b8356be</code> is the target we want to evict replicas out of.</p><p>Edit the node:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl edit -n longhorn-system nodes.longhorn.io node1 </span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Update these two fields and save:</p><ul><li><code>spec.disks.&lt;disk_name&gt;.allowScheduling</code> to <code>false</code></li><li><code>spec.disks.&lt;disk_name&gt;.evictionRequested</code> to <code>true</code></li></ul><p>Sample editing:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">default-disk-ed7af10f5b8356be:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  allowScheduling: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  evictionRequested: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  path: /var/lib/harvester/defaultdisk</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  storageReserved: 36900254515</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tags: []</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li><li><p>Wait for all replicas on the disk to be evicted.</p><p>Get current scheduled replicas on the disk:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get -n longhorn-system nodes.longhorn.io node1 -o yaml | yq e &#x27;.status.diskStatus.default-disk-ed7af10f5b8356be.scheduledReplica&#x27;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Sample output:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">pvc-86d3d212-d674-4c64-b69b-4a2eb1df2272-r-7b422db7: 5368709120</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pvc-b06f0b09-f30c-4936-8a2a-425b993dd6cb-r-bb0fa6b3: 2147483648</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pvc-b844bcc6-3b06-4367-a136-3909251cb560-r-08d1ab3c: 53687091200</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pvc-ea6e0dff-f446-4a38-916a-b3bea522f51c-r-193ca5c6: 10737418240</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Run the command repeatedly, and the output should eventually become an empty map:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">{}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>This means Longhorn evicts replicas on the disk to other disks.</p><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>If a replica always stays in a disk, please open the <a href="https://docs.harvesterhci.io/v1.1/troubleshooting/harvester#access-embedded-rancher-and-longhorn-dashboards" target="_blank" rel="noopener noreferrer">Longhorn GUI</a> and check if there is free space on other disks.</p></div></div></li></ol></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/storage">storage</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/longhorn">longhorn</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/disk">disk</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Evicting Replicas From a Disk (the CLI way)" href="/kb/evicting-replicas-from-a-disk-the-cli-way"><b>Read More</b></a></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 harvesterhci.io</div></div></div></footer></div>
<script src="/assets/js/runtime~main.2ad8bfda.js"></script>
<script src="/assets/js/main.0bb3d69e.js"></script>
</body>
</html>